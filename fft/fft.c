/**
  ******************************************************************************
  * @file	 	FFT.c
  * @author  	Left Radio
  * @version 	1.5.6
  * @date
  * @brief		NeilScope3 FFT sourse
  ******************************************************************************
**/

/* Includes ------------------------------------------------------------------*/
#include <stdlib.h>
#include <string.h>
#include <math.h>
#include <stdint.h>
#include "fft.h"

/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
const float Coeffs_256[256] =		// массив поворотных множителей БПФ
{
		1, 0, 0.999698818696204, -0.0245412285229123, 0.998795456205172, -0.049067674327418, 0.99729045667869, -0.0735645635996674, 0.995184726672197, -0.0980171403295606,
		0.99247953459871, -0.122410675199216, 0.989176509964781, -0.146730474455362, 0.985277642388941, -0.170961888760301, 0.98078528040323, -0.195090322016128, 0.975702130038529, -0.21910124015687,
		0.970031253194544, -0.242980179903264, 0.96377606579544, -0.266712757474898, 0.956940335732209, -0.290284677254462, 0.949528180593037, -0.313681740398892, 0.941544065183021, -0.33688985339222,
		0.932992798834739, -0.359895036534988, 0.923879532511287, -0.38268343236509, 0.914209755703531, -0.40524131400499, 0.903989293123443, -0.427555093430282, 0.893224301195515, -0.449611329654607,
		0.881921264348355, -0.471396736825998, 0.870086991108711, -0.492898192229784, 0.857728610000272, -0.514102744193222, 0.844853565249707, -0.534997619887097, 0.831469612302545, -0.555570233019603,
		0.817584813151583, -0.575808191417846, 0.803207531480645, -0.595699304492434, 0.788346427626606, -0.615231590580627, 0.773010453362737, -0.634393284163646, 0.757208846506484, -0.653172842953777,
		0.740951125354959, -0.671558954847019, 0.724247082951467, -0.689540544737067, 0.707106781186547, -0.707106781186548, 0.689540544737067, -0.724247082951467, 0.671558954847018, -0.740951125354959,
		0.653172842953776, -0.757208846506485, 0.634393284163645, -0.773010453362737, 0.615231590580626, -0.788346427626607, 0.595699304492433, -0.803207531480645, 0.575808191417845, -0.817584813151584,
		0.555570233019602, -0.831469612302546, 0.534997619887097, -0.844853565249707, 0.514102744193221, -0.857728610000272, 0.492898192229784, -0.870086991108712, 0.471396736825997, -0.881921264348355,
		0.449611329654606, -0.893224301195516, 0.427555093430282, -0.903989293123443, 0.40524131400499, -0.914209755703531, 0.38268343236509, -0.923879532511287, 0.359895036534988, -0.932992798834739,
		0.33688985339222, -0.941544065183021, 0.313681740398892, -0.949528180593037, 0.290284677254463, -0.956940335732209, 0.266712757474899, -0.96377606579544, 0.242980179903264, -0.970031253194544,
		0.21910124015687, -0.975702130038528, 0.195090322016129, -0.98078528040323, 0.170961888760302, -0.985277642388941, 0.146730474455362, -0.989176509964781, 0.122410675199217, -0.99247953459871,
		0.0980171403295614, -0.995184726672197, 0.0735645635996683, -0.99729045667869, 0.049067674327419, -0.998795456205172, 0.0245412285229134, -0.999698818696204, 1.17145334231628E-15, -1,
		-0.024541228522911, -0.999698818696204, -0.0490676743274167, -0.998795456205172, -0.073564563599666, -0.99729045667869, -0.0980171403295591, -0.995184726672197, -0.122410675199215, -0.99247953459871,
		-0.14673047445536, -0.989176509964781, -0.170961888760299, -0.985277642388942, -0.195090322016126, -0.980785280403231, -0.219101240156868, -0.975702130038529, -0.242980179903262, -0.970031253194545,
		-0.266712757474896, -0.96377606579544, -0.29028467725446, -0.956940335732209, -0.313681740398889, -0.949528180593037, -0.336889853392218, -0.941544065183022, -0.359895036534986, -0.93299279883474,
		-0.382683432365087, -0.923879532511288, -0.405241314004987, -0.914209755703532, -0.42755509343028, -0.903989293123444, -0.449611329654604, -0.893224301195516, -0.471396736825995, -0.881921264348356,
		-0.492898192229782, -0.870086991108713, -0.514102744193219, -0.857728610000274, -0.534997619887095, -0.844853565249709, -0.5555702330196, -0.831469612302547, -0.575808191417843, -0.817584813151585,
		-0.595699304492431, -0.803207531480647, -0.615231590580624, -0.788346427626608, -0.634393284163643, -0.773010453362739, -0.653172842953774, -0.757208846506487, -0.671558954847016, -0.740951125354961,
		-0.689540544737064, -0.724247082951469, -0.707106781186545, -0.70710678118655, -0.724247082951464, -0.68954054473707, -0.740951125354957, -0.671558954847021, -0.757208846506482, -0.65317284295378,
		-0.773010453362734, -0.634393284163649, -0.788346427626604, -0.61523159058063, -0.803207531480642, -0.595699304492437, -0.817584813151581, -0.575808191417849, -0.831469612302543, -0.555570233019606,
		-0.844853565249705, -0.534997619887101, -0.85772861000027, -0.514102744193226, -0.870086991108709, -0.492898192229788, -0.881921264348353, -0.471396736826002, -0.893224301195513, -0.449611329654611,
		-0.903989293123441, -0.427555093430286, -0.914209755703529, -0.405241314004994, -0.923879532511285, -0.382683432365094, -0.932992798834737, -0.359895036534993, -0.941544065183019, -0.336889853392225,
		-0.949528180593035, -0.313681740398896, -0.956940335732207, -0.290284677254467, -0.963776065795438, -0.266712757474904, -0.970031253194543, -0.242980179903269, -0.975702130038527, -0.219101240156875,
		-0.980785280403229, -0.195090322016134, -0.98527764238894, -0.170961888760307, -0.98917650996478, -0.146730474455368, -0.992479534598709, -0.122410675199222, -0.995184726672196, -0.0980171403295666,
		-0.99729045667869, -0.0735645635996735, -0.998795456205172, -0.0490676743274242, -0.999698818696204, -0.0245412285229185,
};

/* Private variables ---------------------------------------------------------*/
float fft_In[1 << (NS_P + 1)];
float fft_Out[1 << (NS_P + 1)];

/* Private function prototypes -----------------------------------------------*/
static __inline int fft_binary_inversion(int i);	// функция бинарной инверсии индекса
//static void fft_shift(float *data);



/* Private functions ---------------------------------------------------------*/

///*******************************************************************************
//* Function Name  : fft_make
//* Description    : функция расчёта поворотных множителей для БПФ
//* Input          : показатель двойки (например, для БПФ на 256 точек это 8)
//* Output         : результирующий массив поворотных множителей c[1 << p]
//* Return         : None
//*******************************************************************************/
//void fft_make(float *c)
//{
//	uint16_t n, i;
//	float w, f;
//	n = 1 << NS_P; // размер массива (число точек БПФ)
//
//	w = (2. * M_PI) / (float) n;
//	f = 0.;
//
//	for (i = 0; i < n; i++)
//	{
//		*c++ =  cosf(f);
//		*c++ = -sinf(f);
//		f += w;
//	}
//}
//
//
///*******************************************************************************
//* Function Name  : fft_make_reverse
//* Description    : функция расчёта поворотных множителей для ОБПФ
//* Input          : показатель двойки (например, для БПФ на 256 точек это 8)
//* Output         : результирующий массив поворотных множителей c[1 << p]
//* Return         : None
//*******************************************************************************/
//void fft_make_reverse(float *c) // результирующий массив поворотных множителей c[1 << p]
//{
//	int n, i;
//	float w, f;
//	n = 1 << NS_P; // размер массива (число точек ОБПФ)
//	w = (2. * M_PI) / (float) n;
//	f = 0.;
//	for (i = 0; i < n; i++)
//	{
//		*c++ = cosf(f);
//		*c++ = sinf(f);
//		f += w;
//	}
//}



/*******************************************************************************
* Function Name  : fft_realMag_calc
* Description    : функция расчёта прямого БПФ и амплитуд
* Input          : входной массив
* Output         : результирующий массив
* Return         : None
*******************************************************************************/
void fft_realMag_calc(int8_t *In, uint8_t *Out)
{
	uint16_t i;
	uint16_t _NS = (1 << NS_P);

	for(i = 0; i < _NS * 2; i += 2)
	{
		fft_In[i] = (float)((int16_t)(*In) + 127);
		fft_In[i+1] = 0;
		In++;
	}

	fft_calc(fft_In, fft_Out);

	for (i = 0; i <= _NS * 2; i += 2)
	{
		*Out = (uint8_t)(sqrtf((fft_Out[i] * fft_Out[i]) + (fft_Out[i + 1] * fft_Out[i + 1])) / 64.0);
		Out++;
	}
}


/*******************************************************************************
* Function Name  : fft_realMag_calc
* Description    : функция прямого БПФ
* Input          : входной массив
* Output         : результирующий массив
* Return         : None
*******************************************************************************/
void fft_calc(float *in, float *out)
{
	int i;
	int n = 1 << NS_P;  // число точек БПФ
	int n2 = n >> 1; // n/2
	float re, im, re1, im1, re2, im2; // c, c1, c2
	float *p1, *p2;
	const float *p0;

	// копировать элементы массива `in` в массив `out` с битовой инверсией
	for (i = 0; i < n; i++)
	{
		int j = fft_binary_inversion(i) << 1;
		int k = i << 1;

		p0 = in  + j;
		p1 = out + k;
		*p1++ = *p0++; // out[i] = in[j]
		*p1   = *p0;   //

		p0 = in  + k;
		p1 = out + j;
		*p1++ = *p0++; // out[j] = in[i]
		*p1   = *p0;   //
	}

	// выполнение бабочек ("понеслась душа в рай" (C) Hokum)
	for (i = 0; i < NS_P; i++)
	{
		int m = 1 << (i + 1); // через сколько эл-тов бабочка * 2
		int r = m << 1;       // размер группы * 2
		int nom = 0;          // номер группы * r
		int k = 0;            // номер эл-та в группе * 2
		int y = 0;            // индекс W * 2
		int z = 0;
		int h = 1 << (NS_P - i); // шаг для W * 2
		int j;

		for (j = n2; j > 0; j--)
		{
			if (k >= m)
			{
				k = y = 0;
				nom += r;
				z = nom;
			}

			// c <= c[y]
			p0 = Coeffs_256 + y;
			re = *p0++;
			im = *p0;

			// c2 <= out[z + m]
			p1  = out + (z + m);
			re2 = *p1++;
			im2 = *p1;

			// c1 <= c2 * c
			re1 = re2 * re - im2 * im;
			im1 = im2 * re + re2 * im;

			// c2 <= out[z]
			p2  = out + z;
			re2 = *p2++;
			im2 = *p2;

			// out[z]     <= c2 + c1
			// out[z + m] <= c2 - c1
			*p2-- = im2 + im1;
			*p1-- = im2 - im1;
			*p2   = re2 + re1;
			*p1   = re2 - re1;

			k += 2;
			z += 2;
			y += h;
		}
	}
}


/*******************************************************************************
* Function Name  : fft_shift
* Description    : функция перестановки отсчётов спектра (что бы "0" в центре)
* Input          : массив после БПФ
* Output         :
* Return         : None
*******************************************************************************/
//static void fft_shift(float *data)
//{
//	int n = 1 << NS_P; // число точек БПФ
//	float *buf = (float*) malloc(sizeof(float) * 2 * n);
//	if (buf == (float*) NULL) return;
//	else
//	{
//		memcpy(buf, data, sizeof(float) * 2 * n);
//		memcpy(data + n, buf, sizeof(float) * n);
//		memcpy(data, buf + n, sizeof(float) * n);
//		free((void*) buf);
//	}
//}


/*******************************************************************************
* Function Name  : fft_binary_inversion
* Description    : функция бинарной инверсии индекса
* Input          : исходный индекс [0, (1 << NS_P) - 1]
* Output         :
* Return         : None
*******************************************************************************/
static __inline int fft_binary_inversion(int i) //
{
	int j = 0;
	uint8_t p = NS_P;

	while (p-- > 0)
	{
		j <<= 1;
		j |= i & 1;
		i >>= 1;
	}
	return j;
}


